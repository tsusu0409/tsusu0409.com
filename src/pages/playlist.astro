---
import playlistsData from '../data/spotify-playlists.json';
import "../styles/global.css";

interface Playlist {
  id: string;
  name: string;
  description: string;
  images: { url: string }[];
  external_urls: { spotify: string };
  tracks: {
    total: number;
    items: Array<{
      added_at: string;
      track: {
        id: string;
        name: string;
        duration_ms: number;
        explicit: boolean;
        external_urls: { spotify: string };
        artists: Array<{ name: string; external_urls: { spotify: string } }>;
        album: {
          name: string;
          images: { url: string }[];
          external_urls: { spotify: string };
        };
      };
    }>;
  };
}

const playlists = playlistsData as Playlist[];

// 再生時間のフォーマット
function formatDuration(ms: number): string {
  const minutes = Math.floor(ms / 60000);
  const seconds = Math.floor((ms % 60000) / 1000);
  return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// プレイリストの合計時間を計算
function getTotalDuration(playlist: Playlist): string {
  const totalMs = playlist.tracks.items.reduce(
    (sum, item) => sum + item.track.duration_ms,
    0
  );
  const hours = Math.floor(totalMs / 3600000);
  const minutes = Math.floor((totalMs % 3600000) / 60000);
  return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
}
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/images/prof-icon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>Tsusu | Favorite Songs</title>

    <meta property="og:title" content="Tsusu" />
    <meta property="og:description" content="Tsusuの個人サイト" />
    <meta property="og:image" content="https://tsusu0409.com/images/ogp.png" />
    <meta property="og:url" content="https://tsusu0409.com/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Tsusu" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Tsusu" />
    <meta name="twitter:description" content="Tsusuの個人サイト" />
    <meta name="twitter:image" content="https://tsusu0409.com/images/ogp.png" />
    <meta name="twitter:url" content="https://tsusu0409.com/" />

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8366184314757569"
      crossorigin="anonymous"></script>
  </head>

  <body class="bg-white text-black">
    <div class="flex flex-col md:flex-row h-screen">
      <!-- サイドバー（md以上） / モバイルでは上部として振る舞う -->
      <aside class="w-full md:w-64 border-b md:border-b-0 md:border-r border-neutral-800 overflow-y-auto bg-white">
        <div class="p-6">
          <h2 class="text-xl font-bold mb-6 text-neutral-700">Favorite Songs</h2>

          <!-- モバイルでは横スクロール、デスクトップでは縦並び -->
          <nav class="flex md:block gap-2 overflow-x-auto md:overflow-visible pb-2 md:pb-0">
            {playlists.map((playlist) => (
              <button
                data-playlist-id={playlist.id}
                class="playlist-item flex-shrink-0 md:flex-shrink md:w-full text-left px-4 py-3 rounded hover:bg-neutral-100 transition-colors duration-200 border-l-2 border-transparent hover:border-cyan-400"
              >
                <h3 class="font-medium text-neutral-800">{playlist.name}</h3>
              </button>
            ))}
          </nav>
        </div>
      </aside>

      <main class="flex-1 overflow-y-auto bg-white">
        <div id="playlist-detail" class="hidden">
          {playlists.map((playlist) => (
            <div
              data-playlist-content={playlist.id}
              class="playlist-content hidden p-6 md:p-8"
            >
              <div class="mb-6">
                <h1 class="text-2xl md:text-4xl font-bold mb-2 text-neutral-900">{playlist.name}</h1>
                <div class="flex gap-4 text-sm text-neutral-500">
                  <span>{playlist.tracks.total} tracks</span>
                  <span>•</span>
                  <span>{getTotalDuration(playlist)}</span>
                </div>
              </div>

              <!-- 画像グリッド: レスポンシブで列数を変更 -->
              <div class="grid gap-3"
                   style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));">
                {playlist.tracks.items.map((item) => (
                  <a
                    href={item.track.external_urls.spotify}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group relative block w-full aspect-square shadow overflow-hidden rounded"
                  >
                    <!-- 各楽曲のイメージ -->
                    <img
                      src={item.track.album.images[0]?.url}
                      alt={item.track.album.name}
                      class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                    />

                    <!-- ホバー時のオーバーレイ -->
                    <div
                      class="absolute inset-0 flex flex-col justify-end p-2 
                            bg-black/70 opacity-0 group-hover:opacity-100 
                            transition-opacity duration-300"
                    >
                      <p
                        class="text-white text-sm font-bold truncate"
                        title={item.track.name}
                      >
                        {item.track.name}
                      </p>
                      <p
                        class="text-neutral-300 text-xs truncate"
                        title={item.track.artists.map((a) => a.name).join(', ')}
                      >
                        {item.track.artists.map((a) => a.name).join(', ')}
                      </p>
                    </div>
                  </a>
                ))}
              </div>

              <div class="mt-12 mx-0 text-center">
                <a
                  href={playlist.external_urls?.spotify}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-block bg-cyan-400 text-white font-semibold px-5 py-2 rounded-full hover:bg-cyan-500 transition-colors duration-200"
                >
                  このプレイリストを聴く
                </a>
              </div>
            </div>
          ))}
        </div>

        <!-- 空のときの表示 -->
        <div id="empty-state" class="flex items-center justify-center h-full text-neutral-500 p-6">
          <div class="text-center">
            <svg class="w-20 h-20 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
            </svg>
            <p class="text-lg">Select a playlist to view tracks</p>
          </div>
        </div>
      </main>
    </div>

    <script>
      const playlistItems = document.querySelectorAll('.playlist-item');
      const playlistDetail = document.getElementById('playlist-detail');
      const emptyState = document.getElementById('empty-state');

      playlistItems.forEach((item) => {
        item.addEventListener('click', () => {
          const playlistId = item.getAttribute('data-playlist-id');

          // 全てのプレイリストコンテンツを非表示
          document.querySelectorAll('.playlist-content').forEach((content) => {
            content.classList.add('hidden');
          });

          // アクティブ状態を更新
          playlistItems.forEach((i) => {
            i.classList.remove('bg-neutral-100', 'border-cyan-400');
          });
          item.classList.add('bg-neutral-100', 'border-cyan-400');

          // 選択されたプレイリストを表示
          const selectedContent = document.querySelector(
            `[data-playlist-content="${playlistId}"]`
          );
          if (selectedContent) {
            emptyState?.classList.add('hidden');
            playlistDetail?.classList.remove('hidden');
            selectedContent.classList.remove('hidden');
          }
        });
      });
    </script>

    <style>
      aside::-webkit-scrollbar,
      main::-webkit-scrollbar {
        width: 8px;
      }

      aside::-webkit-scrollbar-track,
      main::-webkit-scrollbar-track {
        background: rgb(250, 250, 250);
      }

      aside::-webkit-scrollbar-thumb,
      main::-webkit-scrollbar-thumb {
        background: rgb(192, 192, 192);
        border-radius: 4px;
      }

      aside::-webkit-scrollbar-thumb:hover,
      main::-webkit-scrollbar-thumb:hover {
        background: rgb(160, 160, 160);
      }

      @media (max-width: 420px) {
        .playlist-content .grid > a {
          min-width: 110px;
        }
      }
    </style>
  </body>
</html>
